\subsection{Energy Metering}

\subsubsection{Overview}
A main aspect of the project is the monitoring of energy consumption of the different machines. Interesting to know is how high are the peaks when a file system operation is proceeding. The Energy consumption of the two machines of the live system are monitored continuously by two energy meters. The data then is sent via a developed module every two seconds to the monitoring system Zabbix.

\subsubsection{Energy Meter}
\label{sec:EnergyMeter}
The Energy Meter \textit{EGM-PWM-LAN} of the brand \textit{Energenie} was linked to the power supply unit of the machines. One to the bigger machine ASOK05 and the other one to the office computer. The metering device has an Ethernet interface for connecting it to the existing network. It is possible to connect to the device via an implemented web server which contains a web interface to perform configurations and to see current energy data. Furthermore the web interface can be reached via internet if it is connected to a router with internet access. Energenie offers a cloud service \cite{Energenie.2014} where the energy meter can be registered. Thereafter energy data is sent and diagrams are created by the cloud service. Generated diagrams illustrate the current power usage and the energy consumed in a certain time window. It is also possible to configure the electricity price divided in night- and daytime to show how much money the metered machine has cost.

\subsubsection{System Setup}
An overview of the energy metering setup in the live system can be seen in figure \ref{fig:energyMeteringSetup}. As mentioned in the previous section \ref{sec:EnergyMeter} each energy meter is connected to a machine. The developed module $ EnergyDataPusher $ which fetches the current energy consumption is located in a virtual machine running on ASOK05. The energy data is fetched every two seconds via the module and is then delivered to the $ ZabbixSender $. This module then is responsible for transmitting the information to the Zabbix monitoring.

\begin{figure}
	\centering
	\def\svgwidth{\columnwidth}
	\input{img/energy_SystemSetup.pdf_tex}
	\caption{Energy metering setup}
	\label{fig:energyMeteringSetup}
\end{figure}

\subsubsection{Data Collection}
As the current data is shown on the web interface and is refreshed with every call, the power value is parsed out of the website. The $ EnergyDataPusher $ calls the interface every two seconds, reads the website source code and parses the value. The power value is not yet the actual value, it needs to be calculated with a fixed value of $ 466 $. This information was discovered in the Javascript-file which treats the raw data of the energy meter before it is displayed in the web interface. That are some energy sensor dependant workarounds which is assumed like it is. Thereafter the $ EnergyDataPusher $ calls the $ ZabbixSender $ and passes the parsed values as parameters. The $ ZabbixSender $ uses the API of Zabbix to transmit the data. The sent data is the \textbf{hostname} of the machine and the \textbf{power consumption}.

\subsubsection{Energy Meter Communication Protocol}
With the help of the developed script $ energenie-cloud-dissector.lua $ and Wireshark could be figured out how the communication protocol of the energy meter works and how the data is transmitted to the cloud service. The diagram in figure \ref{fig:energyCommunicationProtocol} shows the call flow between the Energy Meter (EM) and the Cloud. The EM initiates the connection via a Register Request and sends its MAC- and IP-Address to the cloud service. The cloud then acknowledges the register request with its IP-Address and its ID. After the communication channel has been established the EM sends every ten seconds its metered data. Which includes: Cloud-ID, time on device, Power in $ W $, Energy in $ kWh $ divided in night and day, cloud heartbeat request, settings changed. After a certain time sending these data the EM requests a cloud heartbeat.

\begin{figure}
	\centering
	\def\svgwidth{\columnwidth}
	\input{img/energy_CommunicationProtocol.pdf_tex}
	\caption{Communication Call Flow}
	\label{fig:energyCommunicationProtocol}
\end{figure}

Because of routing configurations which would have needed to be done and the missing authorisation to access parts of the system the energy metering keeps running the version of parsing the values out of the web interface.







